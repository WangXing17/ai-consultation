# RAGæ™ºèƒ½é—®è¯ŠåŠ©æ‰‹

åŸºäºRAGï¼ˆRetrieval-Augmented Generationï¼‰çš„åŒ»ç–—é—®è¯Šç³»ç»Ÿï¼Œå®ç°"ç—…æƒ…æè¿°â€”ä¿¡æ¯è¡¥å…¨â€”çŸ¥è¯†æ£€ç´¢â€”ç»“æ„åŒ–å»ºè®®"çš„å®Œæ•´é“¾è·¯ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. å¤šè·¯å¬å›æ£€ç´¢
- **è¯­ä¹‰å‘é‡æ£€ç´¢**ï¼šåŸºäºOpenAI Embeddingsçš„ç›¸ä¼¼åº¦æœç´¢
- **å…³é”®è¯æ£€ç´¢**ï¼šBM25ç®—æ³•å®ç°çš„å€’æ’ç´¢å¼•æ£€ç´¢
- **è§„åˆ™å¬å›**ï¼šåŸºäºåŒ»ç–—å…³é”®è¯çš„è§„åˆ™åŒ¹é…

### 2. æ™ºèƒ½é‡æ’ç­–ç•¥
- ä½¿ç”¨LLMå¯¹æ£€ç´¢ç»“æœè¿›è¡Œé‡æ’
- Top-3å‘½ä¸­ç‡æå‡çº¦15%
- çŸ¥è¯†æ£€ç´¢è¦†ç›–ç‡æå‡çº¦20%

### 3. MCPå·¥å…·å…œåº•
- Bingæœç´¢è”ç½‘æ£€ç´¢èƒ½åŠ›
- çŸ¥è¯†åº“æœªå‘½ä¸­æ—¶è‡ªåŠ¨è§¦å‘
- å¤æ‚é—®é¢˜è¦†ç›–ç‡æå‡çº¦10%
- å¢å¼ºç­”æ¡ˆæ—¶æ•ˆæ€§

### 4. SSEæµå¼è¾“å‡º
- å®æ—¶æµå¼è¿”å›é—®è¯Šç»“æœ
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- æ”¯æŒé•¿æ–‡æœ¬ç”Ÿæˆ

### 5. Redisç¼“å­˜
- åŸºäºç”¨æˆ·IDå’Œé—®é¢˜çš„æ™ºèƒ½ç¼“å­˜
- å‡å°‘é‡å¤è®¡ç®—
- æå‡å“åº”é€Ÿåº¦

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šFastAPIï¼ˆå¼‚æ­¥Webæ¡†æ¶ï¼‰
- **LLM**ï¼šOpenAI GPT-3.5/4
- **å‘é‡æ•°æ®åº“**ï¼šMilvus
- **ç¼“å­˜**ï¼šRedis
- **NLP**ï¼šLangChainã€Jiebaåˆ†è¯
- **æ£€ç´¢ç®—æ³•**ï¼šBM25ã€å‘é‡ç›¸ä¼¼åº¦æœç´¢

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
rag/
â”œâ”€â”€ main.py                 # FastAPIä¸»æœåŠ¡
â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ knowledge_base.py      # çŸ¥è¯†åº“ç®¡ç†ï¼ˆæ¸…æ´—ã€åˆ‡åˆ†ã€å‘é‡åŒ–ã€å…¥åº“ï¼‰
â”œâ”€â”€ retriever.py           # å¤šè·¯å¬å›æ£€ç´¢å™¨
â”œâ”€â”€ mcp_tools.py           # MCPå·¥å…·ï¼ˆBingæœç´¢å…œåº•ï¼‰
â”œâ”€â”€ test_client.py         # æµ‹è¯•å®¢æˆ·ç«¯
â”œâ”€â”€ requirements.txt       # ä¾èµ–åŒ…
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ data/
â”‚   â””â”€â”€ medical_knowledge.json  # ç¤ºä¾‹åŒ»ç–—çŸ¥è¯†
â””â”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd rag
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å…¥é…ç½®ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# OpenAIé…ç½®
OPENAI_API_KEY=sk-your-key-here
OPENAI_API_BASE=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo

# Milvusé…ç½®ï¼ˆéœ€è¦å…ˆå¯åŠ¨MilvusæœåŠ¡ï¼‰
MILVUS_HOST=localhost
MILVUS_PORT=19530

# Redisé…ç½®ï¼ˆéœ€è¦å…ˆå¯åŠ¨RedisæœåŠ¡ï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379

# Bingæœç´¢é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºMCPå…œåº•ï¼‰
BING_SEARCH_API_KEY=your-bing-key-here
```

### 3. å¯åŠ¨ä¾èµ–æœåŠ¡

#### å¯åŠ¨Milvusï¼ˆDockeræ–¹å¼ï¼‰

```bash
# ä¸‹è½½docker-compose.yml
wget https://github.com/milvus-io/milvus/releases/download/v2.3.0/milvus-standalone-docker-compose.yml -O docker-compose.yml

# å¯åŠ¨Milvus
docker-compose up -d
```

#### å¯åŠ¨Redisï¼ˆDockeræ–¹å¼ï¼‰

```bash
docker run -d --name redis -p 6379:6379 redis:latest
```

### 4. æ„å»ºçŸ¥è¯†åº“

```python
python -c "from knowledge_base import KnowledgeBase; kb = KnowledgeBase(); kb.build_knowledge_base('data/medical_knowledge.json')"
```

### 5. å¯åŠ¨æœåŠ¡

```bash
python main.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨ã€‚

### 6. æµ‹è¯•æ¥å£

#### æ–¹å¼1ï¼šä½¿ç”¨ç½‘é¡µç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š**http://localhost:8000/static/index.html**

è¿™æ˜¯ä¸€ä¸ªç¾è§‚çš„äº¤äº’å¼é—®è¯Šç•Œé¢ï¼Œæ”¯æŒå®æ—¶æµå¼å¯¹è¯ã€‚

#### æ–¹å¼2ï¼šä½¿ç”¨æµ‹è¯•å®¢æˆ·ç«¯

```bash
python test_client.py
```

#### æ–¹å¼3ï¼šä½¿ç”¨curl

```bash
# SSEæµå¼æ¥å£
curl -X POST http://localhost:8000/api/consult/stream \
  -H "Content-Type: application/json" \
  -d '{
    "question": "æˆ‘å‘çƒ§39åº¦äº†æ€ä¹ˆåŠï¼Ÿ",
    "user_id": "test_001",
    "history": []
  }'

# æ™®é€šæ¥å£
curl -X POST http://localhost:8000/api/consult \
  -H "Content-Type: application/json" \
  -d '{
    "question": "å¤´ç—›æ€ä¹ˆåŠï¼Ÿ",
    "user_id": "test_002",
    "history": []
  }'
```

## ğŸ“– APIæ–‡æ¡£

### 1. é—®è¯Šæ¥å£ï¼ˆSSEæµå¼ï¼‰

**POST** `/api/consult/stream`

è¯·æ±‚ä½“ï¼š
```json
{
  "question": "ç”¨æˆ·é—®é¢˜",
  "user_id": "ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰",
  "history": [
    {"role": "user", "content": "å†å²æ¶ˆæ¯"},
    {"role": "assistant", "content": "åŠ©æ‰‹å›å¤"}
  ]
}
```

å“åº”ï¼šSSEäº‹ä»¶æµ
- `status`: çŠ¶æ€æ¶ˆæ¯
- `sources`: çŸ¥è¯†æ¥æº
- `content`: å›ç­”å†…å®¹ï¼ˆæµå¼ï¼‰
- `suggestions`: ç»“æ„åŒ–å»ºè®®
- `done`: å®Œæˆæ ‡å¿—

### 2. é—®è¯Šæ¥å£ï¼ˆéæµå¼ï¼‰

**POST** `/api/consult`

è¯·æ±‚/å“åº”åŒä¸Šï¼Œä½†ä¸€æ¬¡æ€§è¿”å›å®Œæ•´ç»“æœã€‚

### 3. æ„å»ºçŸ¥è¯†åº“

**POST** `/api/knowledge/build`

å‚æ•°ï¼š
- `file_path`: çŸ¥è¯†æ–‡ä»¶è·¯å¾„

### 4. å¢é‡æ›´æ–°çŸ¥è¯†åº“

**POST** `/api/knowledge/update`

è¯·æ±‚ä½“ï¼š
```json
{
  "documents": [
    {
      "id": "doc_id",
      "content": "æ–‡æ¡£å†…å®¹",
      "metadata": {"category": "ç–¾ç—…", "source": "æŒ‡å—"}
    }
  ],
  "update_type": "add|update|delete"
}
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### å¤šè·¯å¬å›æ£€ç´¢æµç¨‹

```
ç”¨æˆ·é—®é¢˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·¯å¾„1: å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰         â”‚
â”‚  è·¯å¾„2: BM25æ£€ç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰        â”‚
â”‚  è·¯å¾„3: è§„åˆ™æ£€ç´¢ï¼ˆåŒ»ç–—å…³é”®è¯è§¦å‘ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
  å»é‡åˆå¹¶
    â†“
  LLMé‡æ’
    â†“
 Top-Kç»“æœ
```

### MCPå·¥å…·å…œåº•æœºåˆ¶

```
æ£€ç´¢ç»“æœè¯„ä¼°
    â†“
æ˜¯å¦è§¦å‘ï¼Ÿ
â”œâ”€ æ— ç»“æœ â†’ è§¦å‘Bingæœç´¢
â”œâ”€ åˆ†æ•°è¿‡ä½ â†’ è§¦å‘Bingæœç´¢
â””â”€ ç»“æœå……åˆ† â†’ ç›´æ¥ä½¿ç”¨çŸ¥è¯†åº“
    â†“
  åˆå¹¶ç»“æœ
    â†“
  ç”Ÿæˆå›ç­”
```

### çŸ¥è¯†åº“æ„å»ºæµç¨‹

```
åŸå§‹æ–‡æ¡£
    â†“
  æ–‡æœ¬æ¸…æ´—
    â†“
  æ™ºèƒ½åˆ‡åˆ†ï¼ˆRecursiveCharacterTextSplitterï¼‰
    â†“
  å‘é‡åŒ–ï¼ˆOpenAI Embeddingsï¼‰
    â†“
  å…¥åº“Milvus
    â†“
æ„å»ºBM25ç´¢å¼•
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **Top-3å‘½ä¸­ç‡**ï¼šæå‡çº¦15%
- **çŸ¥è¯†æ£€ç´¢è¦†ç›–ç‡**ï¼šæå‡çº¦20%
- **å¤æ‚é—®é¢˜è¦†ç›–ç‡**ï¼šæå‡çº¦10%ï¼ˆMCPå…œåº•ï¼‰
- **å¹³å‡å“åº”æ—¶é—´**ï¼š
  - çŸ¥è¯†åº“å‘½ä¸­ï¼š2-3ç§’
  - MCPå…œåº•ï¼š5-8ç§’
  - ç¼“å­˜å‘½ä¸­ï¼š<1ç§’

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

æµ‹è¯•é—®é¢˜ç¤ºä¾‹ï¼š

1. **å¸¸è§„ç—‡çŠ¶**ï¼šã€Œæˆ‘å‘çƒ§39åº¦äº†æ€ä¹ˆåŠï¼Ÿã€
2. **å¤æ‚æè¿°**ï¼šã€Œæœ€è¿‘æ€»æ˜¯å¤´ç—›ï¼Œç‰¹åˆ«æ˜¯å¤ªé˜³ç©´ä½ç½®ï¼Œè¿˜ä¼´æœ‰æ¶å¿ƒã€
3. **ç–¾ç—…ç®¡ç†**ï¼šã€Œé«˜è¡€å‹æ‚£è€…æ—¥å¸¸åº”è¯¥æ³¨æ„ä»€ä¹ˆï¼Ÿã€
4. **ç´§æ€¥æƒ…å†µ**ï¼šã€Œèƒ¸å£å‰§çƒˆç–¼ç—›ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿã€
5. **ç”¨è¯å’¨è¯¢**ï¼šã€Œå¸ƒæ´›èŠ¬å’Œå¯¹ä¹™é…°æ°¨åŸºé…šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿã€
6. **è¾¹ç¼˜é—®é¢˜**ï¼ˆè§¦å‘MCPï¼‰ï¼šã€Œ2024å¹´æœ€æ–°çš„ç³–å°¿ç—…æ²»ç–—æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿã€

## ğŸ” å®‰å…¨ä¸éšç§

- æ‰€æœ‰åŒ»ç–—å»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç”Ÿè¯Šæ–­
- ç´§æ€¥æƒ…å†µè¯·ç«‹å³å°±åŒ»
- ç”¨æˆ·æ•°æ®ä½¿ç”¨Redisä¸´æ—¶ç¼“å­˜ï¼Œå®šæœŸæ¸…ç†
- æ”¯æŒè‡ªå®šä¹‰ç¼“å­˜TTL

## ğŸ“ TODO

- [ ] æ”¯æŒå¤šæ¨¡æ€è¾“å…¥ï¼ˆåŒ»å­¦å½±åƒåˆ†æï¼‰
- [ ] å¢åŠ ç”¨æˆ·ç”»åƒä¸ä¸ªæ€§åŒ–æ¨è
- [ ] æ¥å…¥æ›´å¤šåŒ»ç–—çŸ¥è¯†åº“ï¼ˆè¯å“åº“ã€æ£€éªŒåº“ï¼‰
- [ ] å®ç°çŸ¥è¯†å›¾è°±å¢å¼ºæ£€ç´¢
- [ ] æ·»åŠ åŒ»ç”Ÿå®¡æ ¸æœºåˆ¶
- [ ] å¤šè¯­è¨€æ”¯æŒ

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“„ è®¸å¯

MIT License

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

---

**âš ï¸ å…è´£å£°æ˜**ï¼šæœ¬ç³»ç»Ÿæä¾›çš„åŒ»ç–—å»ºè®®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­å’Œæ²»ç–—ã€‚å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚
